<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intuitive Care - Teste Nicolas</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="container mx-auto p-6">
        
        <header class="mb-8 flex justify-between items-center bg-white p-6 rounded-lg shadow-md">
            <div>
                <h1 class="text-3xl font-bold text-blue-800">Intuitive Care</h1>
                <p class="text-gray-600">Painel de Controle de Despesas</p>
            </div>
            <div class="text-right">
                <p class="text-sm font-bold text-green-600">API: Online</p>
                <button @click="carregarEstatisticas" class="text-xs text-blue-500 underline">Atualizar Dados</button>
            </div>
        </header>

        <div v-if="view === 'lista'">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                    <h3 class="text-gray-500 text-sm uppercase">Total Despesas</h3>
                    <p class="text-2xl font-bold">R$ {{ formatarMoeda(stats.total_geral) }}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                    <h3 class="text-gray-500 text-sm uppercase">Média Trimestral</h3>
                    <p class="text-2xl font-bold">R$ {{ formatarMoeda(stats.media_despesa) }}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
                    <h3 class="text-gray-500 text-sm uppercase">Top Estado</h3>
                    <p class="text-2xl font-bold">{{ stats.top_estados?.[0]?.uf || 'Carregando...' }}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="bg-white p-6 rounded-lg shadow lg:col-span-1">
                    <h2 class="text-xl font-bold mb-4">Despesas por Estado</h2>
                    <canvas id="graficoEstados"></canvas>
                </div>

                <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Operadoras</h2>
                        <input 
                            v-model="busca" 
                            @input="buscarOperadoras" 
                            type="text" 
                            placeholder="Buscar operadora..." 
                            class="border rounded px-3 py-2 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-700 uppercase">
                                <tr>
                                    <th class="px-4 py-3">Registro ANS</th>
                                    <th class="px-4 py-3">Razão Social</th>
                                    <th class="px-4 py-3">UF</th>
                                    <th class="px-4 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="op in operadoras" :key="op.registro_ans" class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">{{ op.registro_ans }}</td>
                                    <td class="px-4 py-3">{{ op.razao_social }}</td>
                                    <td class="px-4 py-3">{{ op.uf }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button 
                                            @click="verDetalhes(op.registro_ans)"
                                            class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs"
                                        >
                                            Detalhes
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4 flex justify-between items-center">
                        <button 
                            @click="mudarPagina(-1)" 
                            :disabled="page === 1"
                            class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50"
                        >
                            Anterior
                        </button>
                        <span class="text-gray-600">Página {{ page }}</span>
                        <button 
                            @click="mudarPagina(1)"
                            class="px-3 py-1 bg-gray-200 rounded"
                        >
                            Próxima
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'detalhes'" class="bg-white p-8 rounded-lg shadow-lg">
            <button @click="view = 'lista'" class="mb-4 text-blue-600 hover:underline">← Voltar para Lista</button>
            
            <h2 class="text-2xl font-bold mb-2">{{ operadoraSelecionada.nome }}</h2>
            <p class="text-gray-500 mb-6">Histórico de Despesas Trimestrais</p>

            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-100 border-b">
                        <th class="p-3">Ano</th>
                        <th class="p-3">Trimestre</th>
                        <th class="p-3">Descrição</th>
                        <th class="p-3 text-right">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(desp, index) in operadoraSelecionada.despesas" :key="index" class="border-b">
                        <td class="p-3">{{ desp.ano }}</td>
                        <td class="p-3">{{ desp.trimestre }}</td>
                        <td class="p-3">{{ desp.descricao }}</td>
                        <td class="p-3 text-right font-mono font-bold text-gray-700">R$ {{ formatarMoeda(desp.valor_despesa) }}</td>
                    </tr>
                    <tr v-if="operadoraSelecionada.despesas.length === 0">
                        <td colspan="4" class="p-6 text-center text-gray-500">Nenhum registro encontrado.</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    view: 'lista', // Controla qual tela aparece ('lista' ou 'detalhes')
                    operadoras: [],
                    stats: {},
                    operadoraSelecionada: { nome: '', despesas: [] },
                    page: 1,
                    limit: 10,
                    busca: '',
                    chartInstance: null
                }
            },
            mounted() {
                // Ao iniciar a tela
                this.carregarOperadoras()
                this.carregarEstatisticas()
            },
            methods: {
                async carregarOperadoras() {
                    try {
                        const url = `http://127.0.0.1:8000/api/operadoras?page=${this.page}&limit=${this.limit}&busca=${this.busca}`
                        const res = await fetch(url)
                        const dados = await res.json()
                        this.operadoras = dados.data
                    } catch (error) {
                        alert("Erro ao conectar na API. Verifique se o backend está rodando!")
                        console.error(error)
                    }
                },
                async carregarEstatisticas() {
                    try {
                        const res = await fetch('http://127.0.0.1:8000/api/estatisticas')
                        this.stats = await res.json()
                        this.renderizarGrafico()
                    } catch (error) {
                        console.error(error)
                    }
                },
                async verDetalhes(registroAns) {
                    try {
                        const res = await fetch(`http://127.0.0.1:8000/api/operadoras/${registroAns}/despesas`)
                        const dados = await res.json()
                        
                        this.operadoraSelecionada = {
                            nome: dados.operadora,
                            despesas: dados.despesas
                        }
                        this.view = 'detalhes'
                    } catch (error) {
                        alert("Erro ao carregar detalhes.")
                    }
                },
                buscarOperadoras() {
                    // Reset para pagina 1 quando busca
                    this.page = 1
                    // Debounce simples (espera o usuário parar de digitar um pouco)
                    if (this.timeout) clearTimeout(this.timeout)
                    this.timeout = setTimeout(() => {
                        this.carregarOperadoras()
                    }, 500)
                },
                mudarPagina(delta) {
                    this.page += delta
                    this.carregarOperadoras()
                },
                formatarMoeda(valor) {
                    if (!valor) return '0,00'
                    return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                },
                renderizarGrafico() {
                    if (!this.stats.top_estados) return;

                    const ctx = document.getElementById('graficoEstados');
                    
                    // Se já existe grafico, destroi para criar o novo
                    if (this.chartInstance) this.chartInstance.destroy();

                    this.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: this.stats.top_estados.map(e => e.uf),
                            datasets: [{
                                label: 'Total Despesas',
                                data: this.stats.top_estados.map(e => e.total),
                                backgroundColor: [
                                    '#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444'
                                ],
                                hoverOffset: 4
                            }]
                        }
                    });
                }
            }
        }).mount('#app')
    </script>
</body>
</html>